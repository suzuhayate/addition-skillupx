<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ“˜ è¶³ã—ç®—ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—ã‚·ãƒ¼ãƒˆ</title>
  <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Kosugi Maru', sans-serif;
      background: #f0f8ff;
      color: #333;
      padding: 20px;
      max-width: 1000px;
      margin: auto;
    }
    h1 {
      text-align: center;
      color: #3399ff;
      font-size: 2em;
    }
    .tabs {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }
    .tab {
      padding: 10px 20px;
      background: #cce6ff;
      border-radius: 10px 10px 0 0;
      cursor: pointer;
      margin: 0 5px;
    }
    .tab.active {
      background: #3399ff;
      color: #fff;
      font-weight: bold;
    }
    .tab-content {
      display: none;
      background: white;
      padding: 20px;
      border: 2px solid #99ccff;
      border-radius: 0 10px 10px 10px;
    }
    .tab-content.active {
      display: block;
    }
    table {
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      width: 50px;
      height: 40px;
      text-align: center;
    }
    input[type="number"] {
      width: 40px;
      font-size: 16px;
      text-align: center;
    }
    .controls {
      margin-top: 10px;
    }
    .result {
      margin-top: 10px;
      font-size: 1.1em;
      color: #444;
    }
    .start-btn, .check-btn {
      padding: 10px 20px;
      background-color: #3399ff;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      margin-right: 10px;
      cursor: pointer;
    }
    canvas {
      margin-top: 20px;
    }
    #stampArea {
      margin-top: 10px;
      font-size: 24px;
      color: #0066cc;
    }
    .incorrect {
      color: red;
    }
    table.ranking {
      width: 100%;
      border-collapse: collapse;
      font-size: 1.1em;
      margin-top: 10px;
    }
    table.ranking th, table.ranking td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }
    table.ranking th {
      background: #cce6ff;
    }
  </style>
</head>
<body>
  <h1>ğŸ“˜ è¶³ã—ç®—ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—ã‚·ãƒ¼ãƒˆï¼ˆ100ãƒã‚¹ï¼‹è¨˜éŒ²ï¼‰</h1>

  <div class="tabs">
    <div class="tab active" onclick="switchTab('practice')">ğŸ§  100ãƒã‚¹ãƒãƒ£ãƒ¬ãƒ³ã‚¸</div>
    <div class="tab" onclick="switchTab('record')">ğŸ“Š è¨˜éŒ²ã¨ã‚°ãƒ©ãƒ•</div>
    <div class="tab" onclick="switchTab('ranking')">ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
  </div>

  <div id="practice" class="tab-content active">
    <div class="controls">
      åå‰: <input type="text" id="userName" placeholder="ãªã¾ãˆ" />
      <button class="start-btn" onclick="startPractice()">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      <button class="check-btn" onclick="checkAnswers()">æ¡ç‚¹ã™ã‚‹</button>
      <span id="timer">â±ï¸ 0:00</span>
    </div>
    <div id="gridContainer"></div>
    <div class="result" id="resultArea"></div>
    <div id="stampArea"></div>
  </div>

  <div id="record" class="tab-content">
    <canvas id="scoreChart" width="800" height="300"></canvas>
    <div id="recordList"></div>
  </div>

  <div id="ranking" class="tab-content">
    <h3>ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆä¸Šä½20ä½ï¼‰</h3>
    <table class="ranking" id="rankingTable"></table>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    let startTime = null;
    let timerInterval;
    let chart;
    let bestScore = 0;
    let bestTime = Infinity;
    let stampCount = 0;

    function switchTab(tabId) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.querySelector(`.tab[onclick*="${tabId}"]`).classList.add('active');
      document.getElementById(tabId).classList.add('active');
      if (tabId === 'record') renderChart();
      if (tabId === 'ranking') renderRanking();
    }

    function formatTime(sec) {
      const minutes = Math.floor(sec / 60);
      const seconds = sec % 60;
      return `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function startPractice() {
      const container = document.getElementById("gridContainer");
      container.innerHTML = "";
      document.getElementById("stampArea").innerHTML = "";

      const table = document.createElement("table");
      const rowHeaders = shuffle([...Array(10).keys()].map(i => i + 1));
      const colHeaders = shuffle([...Array(10).keys()].map(i => i + 1));

      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");
      headerRow.innerHTML = "<th>ï¼‹</th>";
      colHeaders.forEach(j => {
        const th = document.createElement("th");
        th.textContent = j;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      for (let i = 0; i < 10; i++) {
        const row = document.createElement("tr");
        const th = document.createElement("th");
        th.textContent = rowHeaders[i];
        row.appendChild(th);
        for (let j = 0; j < 10; j++) {
          const td = document.createElement("td");
          const input = document.createElement("input");
          input.type = "number";
          input.dataset.x = colHeaders[j];
          input.dataset.y = rowHeaders[i];
          input.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
              const inputs = Array.from(document.querySelectorAll("#gridContainer input"));
              const idx = inputs.indexOf(e.target);
              if (idx >= 0 && idx < inputs.length - 1) {
                inputs[idx + 1].focus();
              }
            }
          });
          td.appendChild(input);
          row.appendChild(td);
        }
        tbody.appendChild(row);
      }
      table.appendChild(tbody);
      container.appendChild(table);

      startTime = Date.now();
      clearInterval(timerInterval)
      timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        document.getElementById("timer").textContent = `â±ï¸ ${formatTime(elapsed)}`;
      }, 500);

      document.getElementById("resultArea").textContent = "";
    }

    function getStampByTime(sec) {
      if (sec <= 90) return "ğŸ•Šï¸ é³³å‡°ã‚¹ã‚¿ãƒ³ãƒ—";
      if (sec <= 120) return "ğŸ‰ é¾ã‚¹ã‚¿ãƒ³ãƒ—";
      if (sec <= 180) return "ğŸ¯ ãƒˆãƒ©ã‚¹ã‚¿ãƒ³ãƒ—";
      if (sec <= 240) return "ğŸ¶ çŠ¬ã‚¹ã‚¿ãƒ³ãƒ—";
      if (sec <= 300) return "ğŸŸ é­šã‚¹ã‚¿ãƒ³ãƒ—";
      return "";
    }

    function checkAnswers() {
      clearInterval(timerInterval);
      const inputs = document.querySelectorAll("#gridContainer input");
      let correct = 0;
      let blank = 0;
      let wrong = 0;

      inputs.forEach(input => {
        const x = parseInt(input.dataset.x);
        const y = parseInt(input.dataset.y);
        const correctAnswer = x + y;
        const value = input.value.trim();
        if (value === "") {
          blank++;
        } else if (parseInt(value) === correctAnswer) {
          correct++;
          input.classList.remove("incorrect");
        } else {
          wrong++;
          input.classList.add("incorrect");
        }
      });

      const totalTime = Math.floor((Date.now() - startTime) / 1000);
      const userName = document.getElementById("userName").value || "ãªãªã—";
      const now = new Date().toLocaleString();

      if (blank === 0) {
        const record = { name: userName, correct, wrong, blank, time: totalTime, date: now, stamps: 0 };
        if (correct === 100) {
          const stamp = getStampByTime(totalTime);
          if (stamp) {
            document.getElementById("stampArea").innerHTML = `ğŸ ã”ã»ã†ã³: ${stamp}`;
            record.stamps = 1;
          }
        }
        saveRecord(record);
      }

      document.getElementById("resultArea").textContent =
        `âœ… æ­£è§£: ${correct} ï¼ âŒ ãƒŸã‚¹: ${wrong} ï¼ â¬œ æœªè¨˜å…¥: ${blank} ï¼ â±ï¸ ${formatTime(totalTime)}`;
    }

    function saveRecord(record) {
      const records = JSON.parse(localStorage.getItem("mathRecords_add") || "[]");
      records.push(record);
      localStorage.setItem("mathRecords_add", JSON.stringify(records));
    }

    function renderChart() {
      const ctx = document.getElementById("scoreChart").getContext("2d");
      const records = JSON.parse(localStorage.getItem("mathRecords_add") || "[]");
      const labels = records.map(r => r.date);
      const scores = records.map(r => r.correct);
      const times = records.map(r => r.time);

      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [
            { label: "å¾—ç‚¹", data: scores, borderColor: "#0066cc", backgroundColor: "rgba(0,102,204,0.2)" },
            { label: "æ™‚é–“(ç§’)", data: times, borderColor: "#3399ff", backgroundColor: "rgba(51,153,255,0.2)" }
          ]
        }
      });
    }

    function renderRanking() {
      const records = JSON.parse(localStorage.getItem("mathRecords_add") || "[]");
      records.sort((a, b) => b.correct - a.correct || a.time - b.time);
      const top20 = records.slice(0, 20);
      let html = "<tr><th>é †ä½</th><th>åå‰</th><th>å¾—ç‚¹</th><th>æ™‚é–“</th><th>ã‚¹ã‚¿ãƒ³ãƒ—æ•°</th><th>æ—¥ä»˜</th></tr>";
      top20.forEach((r, i) => {
        html += `<tr>
          <td>${i + 1}</td>
          <td>${r.name}</td>
          <td>${r.correct}</td>
          <td>${formatTime(r.time)}</td>
          <td>${r.stamps || 0}</td>
          <td>${r.date}</td>
        </tr>`;
      });
      document.getElementById("rankingTable").innerHTML = html;
    }
  </script>
</body>
</html>